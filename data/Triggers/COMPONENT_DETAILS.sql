-- PROCESS DATA IN INVENTORY TABLE AUTOMATICALLY

IF DB_ID('CAR_GARAGE_MANAGEMENT') IS NOT NULL
USE CAR_GARAGE_MANAGEMENT

GO

CREATE OR ALTER TRIGGER TG_COMPONENT_DETAILS_INSERT
ON COMPONENT_DETAILS AFTER INSERT 
AS
BEGIN 
	DECLARE 
		@ID_COM CHAR(10), 
		@ID_GARA CHAR(10)

	DECLARE CUR CURSOR FOR
		SELECT ID_COM, ID_GARA 
		FROM INSERTED 
		WHERE STATUS_DETAILS = 0

	OPEN CUR
	FETCH NEXT FROM CUR INTO @ID_COM, @ID_GARA

	WHILE (@@FETCH_STATUS = 0)
	BEGIN
		INSERT INTO INVENTORY_MANAGEMENT (ID_COM, ID_GARA, COM_QUANTITY)
		VALUES 
		(@ID_COM, @ID_GARA, 0)

		FETCH NEXT FROM CUR INTO @ID_COM, @ID_GARA
	END

	CLOSE CUR
	DEALLOCATE CUR
END

GO

CREATE OR ALTER TRIGGER TG_COMPONENT_DETAILS_DELETE
ON COMPONENT_DETAILS AFTER UPDATE
AS
BEGIN 
	IF(UPDATE(STATUS_DETAILS))
	BEGIN
		DECLARE 
			@ID_COM CHAR(10), 
			@ID_GARA CHAR(10)

		DECLARE CUR CURSOR FOR
			SELECT ID_COM, ID_GARA 
			FROM INSERTED 
			WHERE STATUS_DETAILS = 1

		OPEN CUR
		FETCH NEXT FROM CUR INTO @ID_COM, @ID_GARA

		WHILE (@@FETCH_STATUS = 0)
		BEGIN
			DELETE FROM INVENTORY_MANAGEMENT 
			WHERE ID_COM = @ID_COM AND ID_GARA = @ID_GARA

			FETCH NEXT FROM CUR INTO @ID_COM, @ID_GARA
		END

		CLOSE CUR
		DEALLOCATE CUR
	END
END