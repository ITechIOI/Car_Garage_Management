CREATE OR ALTER FUNCTION dbo.GET_MAX_IDREPORT_REVENUE()
RETURNS INT
AS
BEGIN
	DECLARE 
		@MAX_ID_REPORT CHAR(10), 
		@MAX_NUM INT

	IF ((SELECT COUNT(*) FROM REVENUE) = 0)
		RETURN 0

	SELECT TOP 1 @MAX_ID_REPORT = ID_REVENUE_REPORT
	FROM REVENUE
	ORDER BY ID_REVENUE_REPORT DESC;
	
	DECLARE @SUB_MAX CHAR(10) = SUBSTRING(@MAX_ID_REPORT, 4, LEN(@MAX_ID_REPORT))
	SET @MAX_NUM = CAST(@SUB_MAX AS INT)

	RETURN @MAX_NUM
END


CREATE OR ALTER FUNCTION dbo.GET_MAX_IDCUSTOMER()
RETURNS INT
AS
BEGIN
	DECLARE 
		@MAX_ID_CUSTOMER CHAR(10), 
		@MAX_NUM INT

	IF ((SELECT COUNT(*) FROM CUSTOMERS) = 0)
		RETURN 0

	SELECT TOP 1 @MAX_ID_CUSTOMER = ID_CUS
	FROM CUSTOMERS
	ORDER BY ID_CUS DESC;
	
	DECLARE @SUB_MAX CHAR(10) = SUBSTRING(@MAX_ID_CUSTOMER, 4, LEN(@MAX_ID_CUSTOMER))
	SET @MAX_NUM = CAST(@SUB_MAX AS INT)

	RETURN @MAX_NUM
END


ALTER TABLE CUSTOMER_DETAILS
ADD STATUS_CUSD BIT DEFAULT 0
UPDATE CUSTOMER_DETAILS 
SET STATUS_CUSD = 0 

--Stored procedure to insert, update, delete customer 
CREATE OR ALTER PROCEDURE USP_INSERTCUSTOMER
@gara CHAR(10), @name NVARCHAR(100), @phone CHAR(15), @address NVARCHAR(100)
AS
BEGIN
	IF (SELECT COUNT(*) FROM CUSTOMERS WHERE NAME_CUS = @name AND PHONE_NUMBER_CUS = @phone AND STATUS_CUS = 0) = 0
	BEGIN
		DECLARE @MAX_ID SMALLINT
		SET @MAX_ID = dbo.GET_MAX_IDCUSTOMER() + 1
		INSERT CUSTOMERS VALUES ('CUS' + cast(@MAX_ID as char(7)), @name, @phone, @address, 0)
		INSERT CUSTOMER_DETAILS (ID_CUS, ID_GARA) VALUES ('CUS' + cast(@MAX_ID as char(7)), @gara)
	END
	ELSE
	BEGIN
		DECLARE @idCus CHAR(10)
		SET @idCus = (SELECT ID_CUS FROM CUSTOMERS WHERE NAME_CUS = @name AND PHONE_NUMBER_CUS = @phone)
		INSERT CUSTOMER_DETAILS (ID_CUS, ID_GARA) VALUES (@idCus, @gara)
	END
END

CREATE OR ALTER PROCEDURE USP_UPDATECUSTOMER
@id char(10), @name NVARCHAR(100), @phone CHAR(15), @address NVARCHAR(100)
AS
BEGIN
	UPDATE CUSTOMERS 
	SET NAME_CUS = @name, PHONE_NUMBER_CUS = @phone, ADDRESS_CUS = @address
	WHERE ID_CUS = @id
END


CREATE OR ALTER PROCEDURE USP_DELETECUSTOMER
@gara char(10), @id char(10)
AS
BEGIN
	UPDATE CUSTOMER_DETAILS 
	SET STATUS_CUSD = 1
	WHERE ID_CUS = @id AND ID_GARA = @gara
	IF (SELECT COUNT(*) FROM CUSTOMER_DETAILS WHERE ID_CUS = @id AND STATUS_CUSD = 0) = 0
	BEGIN
		UPDATE CUSTOMERS
		SET STATUS_CUS = 1
		WHERE ID_CUS = @id
	END
END

CREATE OR ALTER PROCEDURE USP_UPDATEDEBTOFCUSTOMER
@gara CHAR(10), @id CHAR(10), @updateMoney MONEY 
AS
BEGIN
	UPDATE CUSTOMER_DETAILS 
	SET DEBT = DEBT + @updateMoney
	WHERE ID_CUS= @id AND ID_GARA = @gara
END

ALTER TABLE ACCOUNTS 
ADD CONSTRAINT FK_ACC_STAFF FOREIGN KEY(ID_STAFF) REFERENCES STAFFS(ID_STAFF) 
GO

CREATE OR ALTER FUNCTION dbo.GET_MAX_IDSTAFF()
RETURNS INT
AS
BEGIN
	DECLARE 
		@MAX_ID_STAFF CHAR(10), 
		@MAX_NUM INT

	IF ((SELECT COUNT(*) FROM CUSTOMERS) = 0)
		RETURN 0

	SELECT TOP 1 @MAX_ID_STAFF = ID_STAFF
	FROM STAFFS
	ORDER BY ID_STAFF DESC;
	
	DECLARE @SUB_MAX CHAR(10) = SUBSTRING(@MAX_ID_STAFF, 4, LEN(@MAX_ID_STAFF))
	SET @MAX_NUM = CAST(@SUB_MAX AS INT)

	RETURN @MAX_NUM
END


--Stored procedure to insert, update, delete Staff

CREATE OR ALTER PROCEDURE USP_INSERTSTAFF
@name NVARCHAR(100), @birthday SMALLDATETIME, @address NVARCHAR(100), @email VARCHAR(50), @phone CHAR(15), @salary MONEY, @position nvarchar(50), @gara char(10)
AS
BEGIN
	DECLARE @IDPOS CHAR(10), @MAX_ID INT, @birthday1 smalldatetime
	SELECT @IDPOS = ID_POS FROM STAFF_POSITION WHERE NAME_POS = N'Quản lý'
	SET @MAX_ID=dbo.GET_MAX_IDSTAFF() + 1
	SET DATEFORMAT DMY
	SET @birthday1 = CAST(@birthday AS SMALLDATETIME)
	INSERT STAFFS VALUES ('STF' + cast(@MAX_ID as char(7)), @name, @birthday1, @address, @email, @phone, @salary, @IDPOS, @gara, 0)
END


CREATE OR ALTER PROCEDURE USP_UPDATESTAFF
@id CHAR(10), @name NVARCHAR(100), @birthday SMALLDATETIME, @address NVARCHAR(100), @email VARCHAR(50), @phone CHAR(15), @salary MONEY, @position nvarchar(50)
AS
BEGIN
DECLARE @IDPOS CHAR(10)
	SELECT @IDPOS = ID_POS FROM STAFF_POSITION WHERE NAME_POS = @position	
	UPDATE STAFFS
	SET NAME_STAFF=@name, BIRTHDAY_STAFF=@birthday, ADDRESS_STAFF=@address, EMAIL_STAFF=@email, PHONE_NUMBER_STAFF=@phone, SALARY=@salary, ID_POSITION=@IDPOS
	WHERE ID_STAFF=@id
END

CREATE OR ALTER PROCEDURE USP_DELETESTAFF
@id CHAR(10)
AS
BEGIN	
	UPDATE STAFFS
	SET STATUS_STAFF=1
	WHERE ID_STAFF=@id
END

EXEC USP_INSERTSTAFF @name=N'Bích Phượng', @birthday='20/02/2004' , @address=N'123456', @email='GFHFHFJFK', @phone = '02145633', @salary=100000, @position=N'Quản lý', @gara='GR1'
EXEC USP_UPDATESTAFF @id='STF10', @name=N'Bích Phượng3', @birthday='20/02/2004' , @address=N'123456', @email='GFHFHFJFK', @phone = '02145633', @salary=100000, @position=N'Quản lý'
EXEC USP_DELETESTAFF @id='STF10'
DELETE STAFFS WHERE ID_STAFF='STF10'
SELECT * FROM STAFF_POSITION
SELECT * FROM STAFFS